<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Scout - Messages</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo-svg.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style_main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='font-awesome-4.7.0/css/font-awesome.min.css') }}" />
</head>
<body>
    <div class="wrapper">
        <div class="menu">
            <a href="#" class="menu-btn">
              <div class="menu-buts">
                <i class="fa fa-navicon" aria-hidden="true"></i>
              </div>
            </a>
            <nav class="menu-list">
              <a href="{{ url_for('main.home') }}">Home</a>
              <a href="{{ url_for('main.property_list') }}">Match</a>
              <a href="{{ url_for('main.messages') }}">Messages</a>
              <a href="{{ url_for('main.shortlist') }}">My shortlist</a>
              <a href="{{ url_for('main.login') }}" id="mobile-account-link">Log in</a>
            </nav>
          </div>
    <div class="content">
    </div>
    <nav class="navbar">
        <div class="logo">
            <a href="{{ url_for('main.home') }}"><img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Room Scout Logo"></a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('main.home') }}">Home</a>
            <a href="{{ url_for('main.property_list') }}">Match</a>
            <a href="{{ url_for('main.messages') }}" class="active">Messages</a>
            <a href="{{ url_for('main.shortlist') }}">My shortlist</a>
            <a href="{{ url_for('main.my_account') }}">My Account</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="messages-sidebar">
            <div class="message-sidebar-header">
                <h2>Conversations</h2>
                <!-- TODO: make the new chat button look nice -->
                <button onclick="new_chat()">New Chat</button>
            </div>
            <div class="conversation-list">
                <!-- Dynamically generate conversation items -->
                {% for chat in chats %}
                    <div class="conversation-item" data-id="{{ chat.chatID }}">
                        <div class="conversation-details">
                            <div class="conversation-top">
                                <h3 class="conversation-name">{{ chat.chatName
                                        }}</h3>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">

                <div class="chat-title" style="display: flex;">
                    <div class="chat-title-inner">
                        <h2>Select a conversation</h2>
                        <input id="rename_chat_inp" type="Blabla"> <button
                            onclick="rename_chat()">Rename</button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="invite-button" id="openModalBtn" >Invite person</button>
                    <button class="header-button"
                            id="info-button">Leave Chat</button>
                </div>
            </div>
            <div class="messages-container" id="messages-container">
                <div class="empty-state" id="empty-state">
                    <div class="empty-state-icon">ðŸ’¬</div>
                    <p>Select a conversation to start chatting</p>
                </div>
                <!-- Messages will be loaded here -->
            </div>
            <div class="message-input-container">
                <button class="attachment-button">
                    <i class="fa fa-paperclip"></i>
                </button>
                <textarea class="message-input" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="send-button" onclick="sendMessage()">
                    âž¤
                </button>
            </div>
        </div>

        <div class="modal-overlay" id="modalOverlay">
            <div class="modal">
              <h3>Invite person</h3>
        
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="Search..."
              >
        
              <ul id="namesList"></ul>
        
              <button id="closeModalBtn" class="close-btn">Close</button>
            </div>
          </div>
    </div>
    </div>

    <script src="{{ url_for('static',filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/java.js') }}"></script>

    <script>
        const openModalBtn = document.getElementById('openModalBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const searchInput = document.getElementById('searchInput');
        const namesList = document.getElementById('namesList');
    
        const names = {{ users | safe }};

        function rename_chat() {
            fetch("{{ url_for('main.messages') }}", {
                    method: "POST",
                    body: JSON.stringify({
                        type: "rename_chat",
                        chat_id: current_chat,
                        name: document.getElementById("rename_chat_inp")
                            .value
                    }),
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                }
            ).then(()=> {
                location.reload();
            })
        }
    
        function openModal() {
          modalOverlay.style.display = 'flex'; 
        }
    
        function closeModal() {
          modalOverlay.style.display = 'none';
        }
    
        function renderNamesList(filtered) {
          namesList.innerHTML = '';
    
          filtered.forEach((name) => {
            const li = document.createElement('li');
            
            const span = document.createElement('span');
            span.textContent = name;
            li.appendChild(span);
    
            const checkBtn = document.createElement('button');
            checkBtn.textContent = 'âœ“';
            checkBtn.classList.add('check-btn');
            checkBtn.addEventListener('click', () => {
              console.log(`invited in group: ${name}`);

              fetch("{{ url_for('main.messages') }}", {
                    method: "POST",
                    body: JSON.stringify({
                        type: "add_to_group",
                        chat_id: current_chat,
                        user_id: name
                    }),
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                }
            )

              closeModal();
            });
    
            li.appendChild(checkBtn);
            namesList.appendChild(li);
          });
        }
    
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          const filtered = names.filter((name) =>
            name.toLowerCase().includes(query)
          );
          renderNamesList(filtered);
        });
    
        openModalBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
    

        renderNamesList(names);
    </script>


    <script>
        var intervalId = window.setInterval(function(){
            loadMessages()
            refresh(current_chat)
        }, 10000);



        async function getMessages(id) {
            const response = await fetch("{{ url_for('main.messages') }}", {
                method: "POST",
                body: JSON.stringify({
                    type: "get_chat_messages",
                    chat_id: id
                }),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
            if (response.ok) {
                const data = await response.json()
                var formatted_messages = []
                data.messages.forEach(message => {
                    var message_class = ""
                    if (message.sender === {{ user_id }}) {
                        message_class = "message message-sent"
                    } else {
                        message_class = "message message-received"
                    }
                    formatted_messages.push(`
                    <div class="${message_class}">
                        ${message.message}
                        <div class="message-time">${message.dateSent}</div>
                    </div>
`)
                });
                console.log("Messages:")
                console.log(data.messages)
                console.log(formatted_messages);
                return formatted_messages;
            } else {
                console.error("Error fetching messages");
                return [];
            }
        }

        async function loadMessages() {
            for (const chatId in conversations) {
                conversations[chatId].messages = await getMessages(chatId);
            }
        }
        // Conversation data (dynamically generated from Flask)
        var current_chat = -1
        const conversations = {
            {% for chat in chats %}
                {{ chat.chatID }}: {
                    title: '{{ chat.chatName }}',
                    propertyLink: '{{ "Placeholder" }}',
                    propertyUrl: "{{ '#' }}",
                    infoLink: "{{ '#' }}",
                    avatar: "{{ url_for('static', filename='images/avatar1.png') }}",
                    avatarText: '{{ "Placeholder" }}',
                    messages: []
                },
            {% endfor %}
        };

        loadMessages().then(() => {
            console.log("All messages loaded", conversations);
        });

        function refresh(id) {
            id = parseInt(id, 10);

            // Get conversation data
            const conversation = conversations[id];
            if (!conversation) {
                console.error("No conversation found with ID: " + id);
                return;
            }

            // Update chat content
            const messagesContainer = document.getElementById('messages-container');

            // Process and add new messages using DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            const temp = document.createElement('div');
            temp.innerHTML = conversation.messages;

            // Move all nodes to fragment
            while (temp.firstChild) {
                fragment.appendChild(temp.firstChild);
            }

            // Clear and update message container
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(fragment);

        }

        // Switch conversation function
        function switchConversation(id) {
            console.log("Switching to conversation: " + id);
            current_chat = id;

            // Parse to number
            id = parseInt(id, 10);

            // Get conversation data
            const conversation = conversations[id];
            if (!conversation) {
                console.error("No conversation found with ID: " + id);
                return;
            }
            
            // Update UI active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`.conversation-item[data-id="${id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // Update chat header
            document.querySelector('.chat-title h2').textContent = conversation.title;

            // Get and update property link
            const propertyLinkElement = document.querySelector('.property-link');
            propertyLinkElement.textContent = conversation.propertyLink;
            propertyLinkElement.href = conversation.propertyUrl || '#';
            
            // Update chat content
            const messagesContainer = document.getElementById('messages-container');
            const emptyState = document.getElementById('empty-state');
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Process and add new messages using DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            const temp = document.createElement('div');
            temp.innerHTML = conversation.messages;
            
            // Move all nodes to fragment
            while (temp.firstChild) {
                fragment.appendChild(temp.firstChild);
            }
            
            // Clear and update message container
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(fragment);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            console.log("Chat content updated, message count: " + messagesContainer.children.length);

            const infoButton = document.getElementById('info-button');
            if (conversation.infoLink) {
                infoButton.innerHTML = `<i class="fa fa-info-circle"></i>
                Leave Chat`;
                infoButton.onclick = () => {

                    fetch("{{ url_for('main.messages') }}", {
                        method: "POST",
                        body: JSON.stringify({
                            type: "leave_chat",
                            chat_id: current_chat
                        }),
                        headers: {
                            "Content-type": "application/json; charset=UTF-8"
                        }
                    })
                        .then((responseJson) => {
                            location.reload()
                        })
                };
                infoButton.style.cursor = 'pointer';
            } else {
                infoButton.innerHTML = `<i class="fa fa-info-circle"></i> No Info`;
                infoButton.onclick = null;
                infoButton.style.cursor = 'default';
            }
        }

        // Send message function
        function sendMessage() {
            const input = document.querySelector('.message-input');
            const message = input.value.trim();
            
            if (message === '') return;

            fetch("{{ url_for('main.messages') }}", {
                method: "POST",
                body: JSON.stringify({
                    type: "send_message",
                    chat_id: current_chat,
                    message: message
                }),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
            
            const messagesContainer = document.getElementById('messages-container');
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Create new message element
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-sent';
            messageDiv.innerHTML = `
                ${message}
                <div class="message-time">${currentTime}</div>
            `;
            
            // Add message and reset input
            messagesContainer.appendChild(messageDiv);
            input.value = '';
            input.style.height = 'auto';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // Send message on Enter key (not Shift+Enter)
        document.querySelector('.message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded');
            
            // Add click listeners to conversation items
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    switchConversation(id);
                });
            });
        });
        async function new_chat() {
            const response = await fetch("{{ url_for('main.messages') }}", {
                method: "POST",
                body: JSON.stringify({
                    type: "create_chat",
                    chat_name: "New Chat",
                    people: []
                }),
               headers: {
                   "Content-type": "application/json; charset=UTF-8"
               }
            }).then(()=> {
                location.reload();
            })
        }
    </script>
</body>
</html>