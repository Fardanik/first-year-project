<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Scout - My Shortlist</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo-svg.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style_main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='font-awesome-4.7.0/css/font-awesome.min.css') }}" />
    <style>
        .shortlist-tag {
            padding: 4px 8px;
            background-color: #8d8d8d;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        .property-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .property-features span {
            background-color: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #555;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 12px;
        }
        
        /* Pagination styles from first file */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .pagination-button {
            background-color: #f0f0f0;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-number.active {
            background-color: #ffe15d;
            color: rgb(0, 0, 0);
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="menu">
            <a href="#" class="menu-btn">
              <div class="menu-buts">
                <i class="fa fa-navicon" aria-hidden="true"></i>
              </div>
            </a>
            <nav class="menu-list">
              <a href="{{ url_for('main.home') }}">Home</a>
              <a href="{{ url_for('main.property_list') }}">Match</a>
              <a href="{{ url_for('main.messages') }}">Messages</a>
              <a href="{{ url_for('main.shortlist') }}">My shortlist</a>
              <a href="{{ url_for('main.login') }}" id="mobile-account-link">Log in</a>
            </nav>
          </div>
        <div class="content">
    <nav class="navbar">
        <div class="logo">
            <a href="{{ url_for('main.home') }}"><img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Room Scout Logo"></a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('main.home') }}">Home</a>
            <a href="{{ url_for('main.property_list') }}">Match</a>
            <a href="{{ url_for('main.messages') }}">Messages</a>
            <a href="{{ url_for('main.shortlist') }}" class="active">My shortlist</a>
            <a href="{{ url_for('main.my_account') }}">My Account</a>
        </div>
    </nav>

    <div class="main-container" style="display: block;">
        <div class="page-header">
            <h1 class="header-title">My Shortlist ({{ shortlist|length }})</h1>
            <div class="sort-filter">
                <select class="sort-select">
                    <option value="price-low" selected>Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="bedrooms">Sort by: Bedrooms</option>
                    <option value="bathrooms">Sort by: Bathrooms</option>
                </select>
            </div>
        </div>
        <div class="shortlist-property-grid">
            {% for property in shortlist %}
            <div class="shortlist-property-card">
                <img src="{{ property.image }}" alt="Property" class="card-image">
                <div class="card-content">
                    <h3 class="property-title">{{ property.bedrooms }} Beds {% if property.property_type %}{{ property.property_type }}{% else %}Property{% endif %}</h3>
                    <div class="shortlist-property-price">£{{ property.price_pp_pw }}/week</div>
                    <div class="property-details">
                        <p>{% if property.location %}{{ property.location }}{% else %}Manchester{% endif %}</p>
                    </div>
                    <div class="property-features">
                        <span>{{ property.bedrooms }} bed</span>
                        <span>{{ property.bathrooms }} bath</span>
                    </div>
                    <div class="card-actions">
                        <button class="remove-btn" data-id="{{ property.id }}">Remove</button>
                        <a href="{{ url_for('main.property_info', id=property.id) }}" class="view-btn">View Details →</a>
                    </div>
                </div>
            </div>
            {% endfor %}
            </div>

        <!-- Pagination controls from first file -->
        <div class="pagination" id="paginationContainer">
            <button class="pagination-button" id="prevButton">Previous</button>
            <div class="page-numbers" id="pageNumbersContainer">
                <!-- Will be populated dynamically by JS -->
            </div>
            <button class="pagination-button" id="nextButton">Next</button>
        </div>

        <div class="empty-list" {% if shortlist %}style="display: none;"{% endif %}>
            <h2>Your shortlist is empty</h2>
            <p>Start saving properties you're interested in to compare them later.</p>
            <a href="{{ url_for('main.property_list') }}" class="browse-btn">Browse Properties</a>
        </div>
    </div>
</div>
</div>

    <script src="{{ url_for('static',filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/java.js') }}"></script>

    <script>
        // Load shortlist data from server
        const shortlistData = [
            {% for property in shortlist %}
            {
                id: {{ property.id }},
                image: "{{ property.image }}",
                price: {{ property.price_pp_pw }},
                location: "{% if property.location %}{{ property.location }}{% else %}Manchester{% endif %}",
                bedrooms: {{ property.bedrooms }},
                bathrooms: {{ property.bathrooms }},
                title: "{{ property.bedrooms }} Beds {% if property.property_type %}{{ property.property_type }}{% else %}Property{% endif %}",
                url: "{{ url_for('main.property_info', id=property.id) }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // State management for pagination
        let state = {
            pagination: {
                currentPage: 1,
                itemsPerPage: 6,
                totalPages: 1
            }
        };

        // DOM elements
        const elements = {
            propertyGrid: document.querySelector('.shortlist-property-grid'),
            paginationContainer: document.getElementById('paginationContainer'),
            prevButton: document.getElementById('prevButton'),
            nextButton: document.getElementById('nextButton'),
            pageNumbersContainer: document.getElementById('pageNumbersContainer'),
            emptyList: document.querySelector('.empty-list')
        };

        // All property cards
        let allPropertyCards = [];

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            allPropertyCards = Array.from(document.querySelectorAll('.shortlist-property-card'));
            initializePagination();
            renderProperties();
        });

        // Remove button functionality
        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.shortlist-property-card');
                const propertyId = this.getAttribute('data-id');
                fetch(`{{ url_for('main.home')
                }}property_info/${propertyId}`, {
                    method: "POST",
                    body: JSON.stringify({
                        add_shortlist: false,
                    }),
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                })
                
                card.style.opacity = '0';
                setTimeout(() => {
                    // Remove from DOM and from our array
                    const index = allPropertyCards.indexOf(card);
                    if (index > -1) {
                        allPropertyCards.splice(index, 1);
                    }
                    card.remove();
                    updateShortlistCount();
                    checkEmptyState();
                    
                    // Update pagination
                    state.pagination.totalPages = Math.ceil(allPropertyCards.length / state.pagination.itemsPerPage);
                    
                    // If current page is now greater than total pages, go to last page
                    if (state.pagination.currentPage > state.pagination.totalPages && state.pagination.totalPages > 0) {
                        state.pagination.currentPage = state.pagination.totalPages;
                    }
                    
                    // Re-render properties
                    renderProperties();
                }, 300);
            });
        });

        function updateShortlistCount() {
            const count = allPropertyCards.length;
            document.querySelector('.header-title').textContent = `My Shortlist (${count})`;
        }

        function checkEmptyState() {
            const hasProperties = allPropertyCards.length > 0;
            elements.propertyGrid.style.display = hasProperties ? 'grid' : 'none';
            elements.emptyList.style.display = hasProperties ? 'none' : 'block';
            elements.paginationContainer.style.display = hasProperties && state.pagination.totalPages > 1 ? 'flex' : 'none';
        }

        // Initialize pagination
        function initializePagination() {
            // Calculate total pages
            state.pagination.totalPages = Math.ceil(allPropertyCards.length / state.pagination.itemsPerPage);
            
            // Add event listeners for pagination controls
            elements.prevButton.addEventListener('click', function() {
                if (state.pagination.currentPage > 1) {
                    state.pagination.currentPage--;
                    renderProperties();
                }
            });
            
            elements.nextButton.addEventListener('click', function() {
                if (state.pagination.currentPage < state.pagination.totalPages) {
                    state.pagination.currentPage++;
                    renderProperties();
                }
            });
            
            // Hide pagination if only one page
            elements.paginationContainer.style.display = state.pagination.totalPages > 1 ? 'flex' : 'none';
        }

        // Render pagination controls
        function renderPaginationControls() {
            // Hide pagination if only one page
            if (state.pagination.totalPages <= 1) {
                elements.paginationContainer.style.display = 'none';
                return;
            }
            
            elements.paginationContainer.style.display = 'flex';
            
            // Update prev/next buttons
            elements.prevButton.disabled = state.pagination.currentPage === 1;
            elements.nextButton.disabled = state.pagination.currentPage === state.pagination.totalPages;
            
            // Generate page numbers
            const pageNumbers = [];
            const maxPages = 5;
            let startPage = Math.max(1, state.pagination.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(state.pagination.totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.push(i);
            }
            
            // Render page numbers
            elements.pageNumbersContainer.innerHTML = pageNumbers.map(num => `
                <button class="page-number ${num === state.pagination.currentPage ? 'active' : ''}" data-page="${num}">${num}</button>
            `).join('');
            
            // Add click events to page numbers
            document.querySelectorAll('.page-number').forEach(button => {
                button.addEventListener('click', function() {
                    state.pagination.currentPage = parseInt(this.getAttribute('data-page'));
                    renderProperties();
                });
            });
        }

        // Render properties with pagination
        function renderProperties() {
            // Apply pagination
            const startIndex = (state.pagination.currentPage - 1) * state.pagination.itemsPerPage;
            const endIndex = startIndex + state.pagination.itemsPerPage;
            
            // Remove all property cards from the grid
            elements.propertyGrid.innerHTML = '';
            
            // Add only the cards for the current page
            for (let i = startIndex; i < endIndex && i < allPropertyCards.length; i++) {
                elements.propertyGrid.appendChild(allPropertyCards[i]);
            }
            
            // Render pagination controls
            renderPaginationControls();
            
            // Check empty state
            checkEmptyState();
        }

        // Sort functionality
        document.querySelector('.sort-select').addEventListener('change', function(e) {
            const sortBy = e.target.value;

            allPropertyCards.sort((a, b) => {
                switch(sortBy) {
                    case 'price-low':
                        return getPriceValue(a) - getPriceValue(b);
                    case 'price-high':
                        return getPriceValue(b) - getPriceValue(a);
                    case 'bedrooms':
                        return getBedroomsValue(b) - getBedroomsValue(a);
                    case 'bathrooms':
                        return getBathroomsValue(b) - getBathroomsValue(a);
                    default:
                        return 0;
                }
            });

            // Reset to first page
            state.pagination.currentPage = 1;
            
            // Re-render properties
            renderProperties();
        });

        function getPriceValue(card) {
            const priceText = card.querySelector('.shortlist-property-price').textContent;
            return parseInt(priceText.replace(/[^0-9]/g, ''));
        }

        function getBedroomsValue(card) {
            const features = card.querySelectorAll('.property-features span');
            for (let i = 0; i < features.length; i++) {
                if (features[i].textContent.includes('bed')) {
                    return parseInt(features[i].textContent);
                }
            }
            return 0;
        }
        
        function getBathroomsValue(card) {
            const features = card.querySelectorAll('.property-features span');
            for (let i = 0; i < features.length; i++) {
                if (features[i].textContent.includes('bath')) {
                    return parseInt(features[i].textContent);
                }
            }
            return 0;
        }

        // These functions are used for sorting the properties
        function getBedroomsValue(card) {
            const features = card.querySelectorAll('.property-features span');
            for (let i = 0; i < features.length; i++) {
                if (features[i].textContent.includes('bed')) {
                    return parseInt(features[i].textContent);
                }
            }
            return 0;
        }
        
        function getBathroomsValue(card) {
            const features = card.querySelectorAll('.property-features span');
            for (let i = 0; i < features.length; i++) {
                if (features[i].textContent.includes('bath')) {
                    return parseInt(features[i].textContent);
                }
            }
            return 0;
        }
    </script>
</body>
</html>