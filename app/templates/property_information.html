<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Scout - Property Information</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo-svg.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style_main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='font-awesome-4.7.0/css/font-awesome.min.css') }}" />
</head>
<body>
    <div class="wrapper">
        <div class="menu">
            <a href="#" class="menu-btn">
              <div class="menu-buts">
                <i class="fa fa-navicon" aria-hidden="true"></i>
              </div>
            </a>
            <nav class="menu-list">
              <a href="{{ url_for('main.home') }}">Home</a>
              <a href="{{ url_for('main.property_list') }}">Match</a>
              <a href="{{ url_for('main.messages') }}">Messages</a>
              <a href="{{ url_for('main.shortlist') }}">My shortlist</a>
              <a href="{{ url_for('main.login') }}" id="mobile-account-link">Log in</a>
            </nav>
          </div>
        <div class="content">
    <nav class="navbar">
        <div class="logo">
            <a href="{{ url_for('main.home') }}"><img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Room Scout Logo"></a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('main.home') }}">Home</a>
            <a href="{{ url_for('main.property_list') }}">Match</a>
            <a href="{{ url_for('main.messages') }}">Messages</a>
            <a href="{{ url_for('main.shortlist') }}">My shortlist</a>
            <a href="{{ url_for('main.my_account') }}">My Account</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="property-photos">
            <div class="main-photo">
                <button class="nav-button prev-button" onclick="prevImage()">❮</button>
                <img id="mainPhoto" src="" alt="Property Main Photo">
                <button class="nav-button next-button" onclick="nextImage()">❯</button>
            </div>
            <div class="thumbnail-grid" id="thumbnailGrid"></div>
        </div>
        <div class="property-detail-info">
            <div class="top-bar">
                <div id="top-bar-block" style="display: flex; gap: 20px; align-items: center;">
                    <a href="{{ url_for('main.property_list') }}" style="text-decoration: none;">
                        <button class="back-button">
                            ← Back
                        </button>
                    </a>
                    <div class="view-toggles">
                        <div id="top-bar-block" class="view-toggle active" onclick="switchTab(0)">Overview</div>
                        <div id="top-bar-block" class="view-toggle" onclick="switchTab(1)">Location</div>
                    </div>
                </div>
            </div>

            <div class="tab-panel active" id="overview-panel"></div>
            <div class="tab-panel" id="location-panel"></div>
        </div>
    </div>

    </div></div>

    <script src="{{ url_for('static',filename='js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/java.js') }}"></script>

    <script>
        const propertyData = {
            id: "{{ house.id }}",
            title: "£{{house.price_pp_pw}}/week",
            location: "{{ location }}",
            postcode: "{{ house.postal_code}}",
            bedrooms: "{{ house.bedrooms }}",
            bathrooms: "{{ house.bathrooms }}",
            availableFrom: "{{ house.date_available_from}}",
            tags: [],
            deposit: "£{{ deposit_cost }}",
            images: {{ images | tojson }}
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializePropertyData();
        });

        function initializePropertyData() {
            renderImages();
            renderOverviewPanel();
            if ({{ is_shortlisted | int }}) {
                element = document.getElementById("shortlist-button");
                element.classList.toggle("shortlist-toggled");
                element.textContent = element.classList.contains("shortlist-toggled") ? "Remove from shortlist" : "Add to shortlist";
            }
            renderLocationPanel();
        }

        function renderImages() {
            const mainPhoto = document.getElementById('mainPhoto');
            mainPhoto.src = propertyData.images[0];
            
            const thumbnailGrid = document.getElementById('thumbnailGrid');
            thumbnailGrid.innerHTML = '';
            
            propertyData.images.forEach((image, index) => {
                const img = document.createElement('img');
                img.src = image;
                img.alt = `Property Photo ${index + 1}`;
                img.onclick = function() { setMainImage(index); };
                thumbnailGrid.appendChild(img);
            });
        }

        function renderOverviewPanel() {
            const panel = document.getElementById('overview-panel');
            panel.innerHTML = `
            <button class="shortlist-button" id="shortlist-button">Add to shortlist</button>  

            <h1>${propertyData.title}</h1>
                <div class="details">
                    <p><strong>Location:</strong> ${propertyData.location}</p>
                    <p><strong>Postcode:</strong> ${propertyData.postcode}</p>
                    <p><strong>Bedrooms:</strong> ${propertyData.bedrooms}</p>
                    <p><strong>Bedrooms:</strong> ${propertyData.bathrooms}</p>
                </div>
                <div class="tag-container">
                    ${propertyData.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
                <button class="cta-button">Contact Property</button>
            `;

            document.getElementById("shortlist-button").addEventListener("click", function() {
                this.classList.toggle("shortlist-toggled");
                this.textContent = this.classList.contains("shortlist-toggled") ? "Remove from shortlist" : "Add to shortlist";

                const adding = (this.textContent === "Remove from shortlist")
                console.log(adding)
                
                fetch("{{ url_for('main.property_info', id=house.id) }}", {
                    method: "POST",
                    body: JSON.stringify({
                        add_shortlist: adding,
                    }),
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                })
            });
        }

        function renderLocationPanel() {
            const panel = document.getElementById('location-panel');
            panel.innerHTML = `
                <style> 
                    #map {
                        width: 100%;
                        height: 400px;
                        object-fit: cover;
                        border-radius: 8px;
                    }
                </style>

                <h2>Location</h2>
                
                <div id="map"></div>
            `;

            const script = document.createElement('script');
            script.src = "https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js";
            document.head.appendChild(script);
            
            script.onload = function() {
                mapkit.init({
                    authorizationCallback: function(done) {
                        done(""); // Replace with your actual token
                    }
                });
                
                const map = new mapkit.Map("map");
                
                var centerCoordinate = new mapkit.Coordinate(53.465930954133505, -2.2321314982809373);
                var centerSpan = new mapkit.CoordinateSpan(0.032, 0.032);
                var region = new mapkit.CoordinateRegion(centerCoordinate, centerSpan);
                map.setRegionAnimated(region);
            
                try { 
                    let house = JSON.parse('{{ house | tojson | safe }}');
                    house_postcode = (house.postal_code);
                }
                catch (e) {
                    console.log("No postcode found for this property")
                }

                function addPin(map, latitude, longitude, title, color = "red") {
                    if (!mapkit || !map) {
                        console.error("MapKit JS is not initialized or map is missing.");
                        return;
                    }

                    let coordinate = new mapkit.Coordinate(latitude, longitude);

                    let annotation = new mapkit.MarkerAnnotation(coordinate, {
                        title: title,
                        color: color,
                        calloutEnabled: true,
                    });
                    map.addAnnotations([annotation]);
                }

                function getCoordinates(address) {
                    return new Promise((resolve, reject) => {
                      if (!mapkit || !mapkit.Search) {
                          return reject("MapKit JS is not initialized.");
                      }

                      const geocoder = new mapkit.Geocoder();
                      
                      geocoder.lookup(address, function(error, data) {
                          if (error) {
                              console.error("Geocoding error:", error);
                              return reject(error);
                          }

                          if (data.results.length > 0) { 
                              var coordinate = data.results[0].coordinate;
                              var lat = coordinate.latitude;
                              var long = coordinate.longitude;
                              
                              return resolve([lat,long]);
                            }
                          else {
                            return reject("No results found");
                          }}
                      );
                  });
                }
                    
                getCoordinates(house_postcode)
                  .then(([latitude,longitude]) => { 
                      addPin(map,latitude,longitude,title="",color="#efda51")
                  })
                  .catch(error => {
                      console.error("Error getting coordinates",error);
                  });
            }
        }

        let currentImageIndex = 0;

        function updateMainImage() {
            document.getElementById('mainPhoto').src = propertyData.images[currentImageIndex];
        }

        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % propertyData.images.length;
            updateMainImage();
        }

        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + propertyData.images.length) % propertyData.images.length;
            updateMainImage();
        }

        function setMainImage(index) {
            currentImageIndex = index;
            updateMainImage();
        }

        function switchTab(tabIndex) {
            const toggles = document.querySelectorAll('.view-toggle');
            const panels = document.querySelectorAll('.tab-panel');

            toggles.forEach(toggle => toggle.classList.remove('active'));
            panels.forEach(panel => panel.classList.remove('active'));

            toggles[tabIndex].classList.add('active');
            panels[tabIndex].classList.add('active');
        }
    </script>
</body>
</html>